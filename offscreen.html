<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="handtrack.min.js"></script>
</head>

<body>
    <script>
        let webcam = null;
        let model = null;
        let webcamRunning = false;

        const modelParams = {
            flipHorizontal: true,
            maxNumBoxes: 1,
            iouThreshold: 0.5,
            scoreThreshold: 0.7,
        };
        handTrack.load(modelParams).then(loadedModel => {
            model = loadedModel;
        }).catch(err => {
            chrome.runtime.sendMessage({ action: 'error', message: 'Failed to load model: ' + err });
        });

        // Listen for messages from popup
        chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
            if (message.action === 'enableWebcam') {
                startCamera();
            } else if (message.action === 'disableWebcam') {
                stopCamera();
            }
        });

        async function startCamera() {
            if (webcamRunning || !model) return;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });

                webcam = document.createElement('video');
                webcam.autoplay = true;
                webcam.playsInline = true;
                webcam.muted = true;
                webcam.style.display = 'none';
                document.body.appendChild(webcam);
                webcam.srcObject = stream;
                webcamRunning = true;

                webcam.addEventListener('loadeddata', () => {
                    handTrack.startVideo(webcam);
                    detectHands();
                    chrome.runtime.sendMessage({ action: 'cameraStatus', active: true });
                });
            } catch (err) {
                chrome.runtime.sendMessage({ action: 'error', message: 'Camera access denied: ' + err });
            }
        }

        function stopCamera() {
            if (!webcamRunning) return;

            if (webcam && webcam.srcObject) {
                webcam.srcObject.getTracks().forEach(track => track.stop());
                webcam.pause();
                webcam.srcObject = null;
                webcamRunning = false;
                chrome.runtime.sendMessage({ action: 'cameraStatus', active: false });
            }
        }

        function detectHands() {
            if (!webcamRunning) return;

            handTrack.detect(webcam).then(predictions => {
                if (predictions.length > 0) {
                    const hand = predictions[0];
                    chrome.runtime.sendMessage({
                        action: 'gesture',
                        gesture: 'handDetected',
                        confidence: hand.score
                    });
                }
                requestAnimationFrame(detectHands);
            }).catch(err => {
                chrome.runtime.sendMessage({ action: 'error', message: 'Detection error: ' + err });
            });
        }
    </script>
</body>

</html>